!function(e,n){if("function"==typeof define&&define.amd)define("wsps",[],n);else{if("function"==typeof require&&null!=("undefined"!=typeof module&&null!==module?module.exports:void 0))return module.exports=n();e.WSPS=n()}}(this,function(){var e=function(e,n){var t=Object.create(e);for(var o in n)(n.hasOwnProperty(o)||"undefined"===t[o])&&(t[o]=n[o]);return t["super"]=function(){return e},t},n="undefined"!=typeof WebSocket,t="undefined"!=typeof process,o="undefined"!=typeof require,i=!(!n&&t&&o);i||(WebSocket=require("ws"));var s=!1,c=e({},{create:function(e){var n=Object.create(this),t={server:void 0,onconnect:void 0,onclose:void 0,debug:s};for(var o in t)t.hasOwnProperty(o)&&void 0===e[o]&&(e[o]=t[o]);return n._initialize(e),n},connect:function(){this._socket&&this.disconnect(),this._log("Connecting to WSPS server at: "+this._config.server);var e=this;this._socket=new WebSocket(this._config.server),i?(this._socket.onopen=function(){e._onopen()},this._socket.onclose=function(){e._onclose()},this._socket.onmessage=function(n){e._onmessage(n.data)},this._socket.onerror=function(){e._onerror()}):(this._socket.on("open",function(){e._onopen()}),this._socket.on("message",function(n){e._onmessage(n)}),this._socket.on("close",function(){e._onclose()}))},disconnect:function(){this._socket.close(),this._socket=null},publish:function(e,n,t){if(!this._socket)throw new Error("Trying to publish data without a connection");var o={type:"publish",channel:e,data:n,key:t};try{return this._socket.send(JSON.stringify(o)),!0}catch(i){return this._log("Caught error when sending",i),!1}},subscribe:function(e,n,t){this._channelListeners[e]||(this._channelListeners[e]=[]),this._channelListeners[e].push(n),this._subscribe(e,t)},_initialize:function(e){this._validateConfig(e),this._config=e,this._channelListeners={},this._subscriptions=[],this._socket=null},_validateConfig:function(e){if(!e.server)throw new Error("Cannot initialize WSPS without a server.")},_subscribe:function(e,n){if(this._subscriptions.push({channel:e,key:n}),this._socket){var t={type:"subscribe",channel:e,key:n};this._socket.send(JSON.stringify(t))}},_onopen:function(){this._log("Connection to "+this._config.server+" opened");for(var e in this._subscriptions){var n=this._subscriptions[e];this._subscribe(n.channel,n.key)}this._config.onconnect&&this._config.onconnect()},_onclose:function(){this._log("Connection to "+this._config.server+" closed"),this._config.onclose&&this._config.onclose()},_onmessage:function(e){var n=JSON.parse(e),t=this._channelListeners[n.channel];if(t)for(var o=0,i=t.length;i>o;o+=1)t[o](n)},_onerror:function(){this._log("_onerror")},_log:function(){if(this._config.debug&&"undefined"!=typeof console&&console.log){var e=Array.prototype.splice.call(arguments,0);e.unshift(this._getTimestamp()),console.log.apply(console,e)}},_getTimestamp:function(e){e=e||new Date;var n=new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds());return n.toISOString()}});return c});